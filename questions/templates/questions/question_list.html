{% extends 'base.html' %}

{% block title %}ì§ˆë¬¸ ê²Œì‹œíŒ{% endblock %}

{% block extra_css %}
<style>
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .categories {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .category-btn {
        padding: 0.5rem 1rem;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        color: #333;
    }
    .category-btn.active {
        background-color: #3498db;
        color: white;
        border-color: #3498db;
    }
    .question-card {
        background-color: white;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-decoration: none;
        color: #333;
        display: block;
        transition: transform 0.2s;
    }
    .question-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .question-card.resolved {
        opacity: 0.6;
        text-decoration: line-through;
    }
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .question-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .question-meta {
        font-size: 0.9rem;
        color: #7f8c8d;
    }
    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
    }
    .badge-resolved {
        background-color: #27ae60;
        color: white;
    }
    .badge-category {
        background-color: #3498db;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>ì§ˆë¬¸ ê²Œì‹œíŒ</h1>
    <a href="{% url 'questions:create' %}" class="btn">ì§ˆë¬¸í•˜ê¸°</a>
    <a href="{% url 'questions:my_questions' %}" class="btn">ë‚´ê°€ ì“´ ê¸€</a>
    <a href="{% url 'questions:my_scrapped_questions' %}" class="btn">ì°œí•œ ê¸€</a>
</div>

<div class="categories">

  <a href="{% url 'questions:list' %}"
     class="category-btn {% if not selected_category %}active{% endif %}">
    ì „ì²´
  </a>
  <!-- ê²€ìƒ‰ í¼ ì¶”ê°€ -->
<form id="searchForm" style="display:flex; gap:8px; align-items:center;">
  <input
    id="searchInput"
    type="text"
    name="q"
    placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
    value="{{ q|default:'' }}"
    style="padding:8px 10px; border:1px solid #ddd; border-radius:6px;"
  />
  <button type="submit" class="btn">ê²€ìƒ‰</button>
</form>

  
  <!--ì¹´í…Œê³ ë¦¬ ì„ íƒ:ë“œë¡­ë‹¤ìš´-->
  <select id="categorySelect" class="category-select">
    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>

    {% for c in categories %}
      <option value="{{ c.id }}"
        {% if selected_category and selected_category.id == c.id %}selected{% endif %}>
        {{ c.name }} 
      </option>
    {% endfor %}
  </select>

  <!--ì •ë ¬ ì„ íƒ ë“œë¡­ë‹¤ìš´-->
  <select id="sortSelect" class="category-select">
    <option value="latest" {% if selected_sort != "oldest" %}selected{% endif %}>ìµœì‹ ìˆœ</option>
    <option value="oldest" {% if selected_sort == "oldest" %}selected{% endif %}>ì˜¤ë˜ëœìˆœ</option>
  </select>
</div>

<script>
  // ì„ íƒê°’ìœ¼ë¡œ URL ë§Œë“¤ê³  ì´ë™í•˜ëŠ” í•¨ìˆ˜
  function goWithFilters() {
    const categoryId = document.getElementById("categorySelect").value;
    const sort = document.getElementById("sortSelect").value || "latest";
    const q = document.getElementById("searchInput")?.value?.trim() || "";
    const scope = document.getElementById("scopeSelect")?.value || "all";

    // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ ì „ì²´ í˜ì´ì§€ë¡œ, ì„ íƒí–ˆìœ¼ë©´ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ë¡œ
    const baseUrl = categoryId
      ? "{% url 'questions:list_by_category' 0 %}".replace("/0/", "/" + categoryId + "/")
      : "{% url 'questions:list' %}";

    const params = new URLSearchParams(window.location.search);
    params.set("sort", sort);
    params.set("scope", scope);


    if(q) params.set("q", q);
    else params.delete("q");

    const qs = params.toString();
    location.href = qs ? `${baseUrl}?${qs}` : baseUrl;
  }

    document.getElementById("categorySelect").addEventListener("change", goWithFilters);
    document.getElementById("sortSelect").addEventListener("change", goWithFilters);
    document.getElementById("scopeSelect")?.addEventListener("change", goWithFilters);

    document.getElementById("searchForm").addEventListener("submit", function(e){
    e.preventDefault();
    goWithFilters();
  });
</script>

{% if faq_questions %}
  <div style="margin: 10px 0 18px; background:#fffbe6; border:1px solid #ffe58f; padding:14px; border-radius:8px;">
    <div style="font-weight:700; margin-bottom:8px;">ğŸ“Œ FAQ (ìì£¼ ë¬»ëŠ” ì§ˆë¬¸)</div>
    <ul style="margin:0; padding-left:18px;">
      {% for fq in faq_questions %}
        <li style="margin:6px 0;">
          <a href="{% url 'questions:detail' fq.pk %}" style="text-decoration:none; color:#333;">
            {{ fq.title }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% if questions %}
{% for question in questions %}
  <div class="question-card {% if question.is_resolved %}resolved{% endif %}"
       style="position:relative;">
    <!--ì°œ ë²„íŠ¼-->
    <form method="post" action="{% url 'questions:toggle_scrap' question.pk %}"
          style="position:absolute; top:12px; right:12px; z-index:10;">
      {% csrf_token %}
      <button type="submit"
              style="border:none; background:transparent; font-size:22px; cursor:pointer;
                     color:#facc15; text-shadow:0 0 1px rgba(0,0,0,0.25);">
        {% if user in question.scraps.all %}â˜…{% else %}â˜†{% endif %}
      </button>
    </form>

    <!--ì¹´ë“œ ë‚´ìš©-->
    <a href="{% url 'questions:detail' question.pk %}" style="display:block; padding:16px; text-decoration:none; color:inherit;">
      <div class="question-header">
        <div class="question-title">
          {% if question.is_resolved %}âœ“{% endif %} {{ question.title }}
        </div>
        <div>
          <span class="badge badge-category">{{ question.category.name }}</span>
          {% if question.is_resolved %}
            <span class="badge badge-resolved">í•´ê²°ë¨</span>
          {% endif %}
        </div>
      </div>

      <div class="question-meta">
        ì‘ì„±ì: {% if question.is_anonymous %}ìµëª…{% else %}{{ question.author.username }}{% endif %} |
        ì‘ì„±ì¼: {{ question.created_at|date:"Y-m-d H:i" }} |
        ë‹µë³€: {{ question.answers.count }}ê°œ
      </div>
    </a>

  </div>
{% endfor %}


{% else %}
    <p>ì•„ì§ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}
{% endblock %}
